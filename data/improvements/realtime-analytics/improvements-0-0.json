{
    "Method_Improvements": {
        "Improvements": [
            {
                "Improvement": "Extract duplicate code into a method",
                "Change_Diff": "- subSession=new SubSession();\n- subSession.setIdentifier(subSessionIdenfifier);\n- subSession.setName(profile.getName());\n- subSession.setCreationTime(currentTime);\n- subSession.setEventCount(1);\n- if (info.getTtl() > 0) {\n-   subSession.setTtl(Math.min(info.getTtl(),maxSessionIdleTime));\n- }\nelse {\n-   subSession.setTtl(Math.min(profile.getDefaultTtl(),maxSessionIdleTime));\n- }\n- if (subSession.getTtl() > session.getTtl()) {\n-   subSession.setTtl(session.getTtl());\n- }\n- subSession.setFirstEventTimestamp(eventTimestamp);\n- subSession.setLastModifiedTime(currentTime);\n- subSession.setExpirationTime(currentTime + subSession.getTtl());\n- subSession.setSessionId(concatTimestamp(session.getIdentifier(),subSessionIdenfifier,subSession.getFirstEventTimestamp()));\n+ setupSubSession(subSession, session, profile, info, eventTimestamp, currentTime);",
                "Description": "The logic for creating and setting up a subSession is duplicated in the 'if' and 'else if' conditions. This logic can be extracted into a separate method, which will make the code cleaner and easier to understand. It will also reduce the chance of errors.",
                "Start": 5,
                "End": 32
            },
            {
                "Improvement": "Extract logic to check TTL into a method",
                "Change_Diff": "- if (info.getTtl() > 0) {\n-   subSession.setTtl(Math.min(info.getTtl(),maxSessionIdleTime));\n- }\nelse {\n-   subSession.setTtl(Math.min(profile.getDefaultTtl(),maxSessionIdleTime));\n- }\n- if (subSession.getTtl() > session.getTtl()) {\n-   subSession.setTtl(session.getTtl());\n- }\n+ checkTTL(subSession, session, profile, info);",
                "Description": "The logic to check for the TTL (Time To Live) is duplicated. This logic can be extracted into a separate method, which will make the code cleaner and easier to understand.",
                "Start": 10,
                "End": 15
            }
        ],
        "Final code": "private void processSubSession(JetstreamEvent event,Session session,String mainIdentifier,SessionizationInfo info,SubSessionProfile profile,long eventTimestamp){\n  String subSessionIdenfifier=info.getIdentifier();\n  SubSession subSession=session.getSubSession(subSessionIdenfifier,profile.getName());\n  long currentTime=session.getLastModifiedTime();\n  if (subSession == null) {\n    subSession=new SubSession();\n    setupSubSession(subSession, session, profile, info, eventTimestamp, currentTime);\n    session.addSubSession(subSession);\n  }\n  else if (subSession.getExpirationTime() < session.getLastModifiedTime()) {\n    subSessionEnd(mainIdentifier,session,subSession);\n    setupSubSession(subSession, session, profile, info, eventTimestamp, currentTime);\n    if (subSession.getInitialAttributes() != null) {\n      subSession.getInitialAttributes().clear();\n    }\n    if (subSession.getDynamicAttributes() != null) {\n      subSession.getDynamicAttributes().clear();\n    }\n  }\n  else {\n    subSession.setSessionId(concatTimestamp(session.getIdentifier(),subSessionIdenfifier,subSession.getFirstEventTimestamp()));\n    if (subSession.getEventCount() < Integer.MAX_VALUE) {\n      subSession.setEventCount(subSession.getEventCount() + 1);\n    }\n    subSession.setExpirationTime(currentTime + subSession.getTtl());\n    subSession.setLastModifiedTime(currentTime);\n  }\n  if (session.getExpirationTime() < subSession.getExpirationTime()) {\n    session.setExpirationTime(subSession.getExpirationTime());\n  }\n  EsperSessionizer subEsperSessionizer=subEsperSessionizerMap.get(profile.getName());\n  if (subEsperSessionizer != null && subEsperSessionizer.isEventSupported(event)) {\n    subEsperSessionizer.process(subSession,session,event);\n  }\n  if (subSession.getEventCount() == 1 && profile.getBeginMarker() != null) {\n    JetstreamEvent sessionBeginEvent=new JetstreamEvent();\n    sessionBeginEvent.setEventType(profile.getBeginMarker());\n    Map<String,Object> initialAttributes=subSession.getInitialAttributes();\n    if (initialAttributes != null) {\n      sessionBeginEvent.putAll(initialAttributes);\n    }\n    if (profile.getSessionIdKey() != null) {\n      sessionBeginEvent.put(profile.getSessionIdKey(),subSession.getSessionId());\n    }\n    if (mainSessionProfile.getSessionStartTimestampKey() != null) {\n      sessionBeginEvent.put(mainSessionProfile.getSessionStartTimestampKey(),subSession.getCreationTime());\n    }\n    if (subEsperSessionizer != null && subEsperSessionizer.isEventSupported(sessionBeginEvent)) {\n      subEsperSessionizer.process(subSession,session,sessionBeginEvent);\n    }\n    eventSender.sendSubSessionBeginEvent(mainSessionProfile.getSessionType(),subSession,sessionBeginEvent);\n  }\n}\n\nprivate void setupSubSession(SubSession subSession, Session session, SubSessionProfile profile, SessionizationInfo info, long eventTimestamp, long currentTime) {\n  subSession.setIdentifier(info.getIdentifier());\n  subSession.setName(profile.getName());\n  subSession.setCreationTime(currentTime);\n  subSession.setEventCount(1);\n  checkTTL(subSession, session, profile, info);\n  subSession.setFirstEventTimestamp(eventTimestamp);\n  subSession.setLastModifiedTime(currentTime);\n  subSession.setExpirationTime(currentTime + subSession.getTtl());\n  subSession.setSessionId(concatTimestamp(session.getIdentifier(),info.getIdentifier(),subSession.getFirstEventTimestamp()));\n}\n\nprivate void checkTTL(SubSession subSession, Session session, SubSessionProfile profile, SessionizationInfo info) {\n  if (info.getTtl() > 0) {\n    subSession.setTtl(Math.min(info.getTtl(),maxSessionIdleTime));\n  }\n  else {\n    subSession.setTtl(Math.min(profile.getDefaultTtl(),maxSessionIdleTime));\n  }\n  if (subSession.getTtl() > session.getTtl()) {\n    subSession.setTtl(session.getTtl());\n  }\n}"
    },
    "Old_Method": "private void processSubSession(JetstreamEvent event,Session session,String mainIdentifier,SessionizationInfo info,SubSessionProfile profile,long eventTimestamp){\n  String subSessionIdenfifier=info.getIdentifier();\n  SubSession subSession=session.getSubSession(subSessionIdenfifier,profile.getName());\n  long currentTime=session.getLastModifiedTime();\n  if (subSession == null) {\n    subSession=new SubSession();\n    subSession.setIdentifier(subSessionIdenfifier);\n    subSession.setName(profile.getName());\n    subSession.setCreationTime(currentTime);\n    subSession.setEventCount(1);\n    if (info.getTtl() > 0) {\n      subSession.setTtl(Math.min(info.getTtl(),maxSessionIdleTime));\n    }\n else {\n      subSession.setTtl(Math.min(profile.getDefaultTtl(),maxSessionIdleTime));\n    }\n    if (subSession.getTtl() > session.getTtl()) {\n      subSession.setTtl(session.getTtl());\n    }\n    subSession.setFirstEventTimestamp(eventTimestamp);\n    subSession.setLastModifiedTime(currentTime);\n    subSession.setExpirationTime(currentTime + subSession.getTtl());\n    subSession.setSessionId(concatTimestamp(session.getIdentifier(),subSessionIdenfifier,subSession.getFirstEventTimestamp()));\n    session.addSubSession(subSession);\n  }\n else   if (subSession.getExpirationTime() < session.getLastModifiedTime()) {\n    subSessionEnd(mainIdentifier,session,subSession);\n    subSession.setCreationTime(currentTime);\n    subSession.setEventCount(1);\n    if (info.getTtl() > 0) {\n      subSession.setTtl(Math.min(info.getTtl(),maxSessionIdleTime));\n    }\n else {\n      subSession.setTtl(Math.min(profile.getDefaultTtl(),maxSessionIdleTime));\n    }\n    if (subSession.getTtl() > session.getTtl()) {\n      subSession.setTtl(session.getTtl());\n    }\n    subSession.setFirstEventTimestamp(eventTimestamp);\n    subSession.setLastModifiedTime(currentTime);\n    subSession.setExpirationTime(currentTime + subSession.getTtl());\n    subSession.setSessionId(concatTimestamp(session.getIdentifier(),subSessionIdenfifier,subSession.getFirstEventTimestamp()));\n    if (subSession.getInitialAttributes() != null) {\n      subSession.getInitialAttributes().clear();\n    }\n    if (subSession.getDynamicAttributes() != null) {\n      subSession.getDynamicAttributes().clear();\n    }\n  }\n else {\n    subSession.setSessionId(concatTimestamp(session.getIdentifier(),subSessionIdenfifier,subSession.getFirstEventTimestamp()));\n    if (subSession.getEventCount() < Integer.MAX_VALUE) {\n      subSession.setEventCount(subSession.getEventCount() + 1);\n    }\n    subSession.setExpirationTime(currentTime + subSession.getTtl());\n    subSession.setLastModifiedTime(currentTime);\n  }\n  if (session.getExpirationTime() < subSession.getExpirationTime()) {\n    session.setExpirationTime(subSession.getExpirationTime());\n  }\n  EsperSessionizer subEsperSessionizer=subEsperSessionizerMap.get(profile.getName());\n  if (subEsperSessionizer != null && subEsperSessionizer.isEventSupported(event)) {\n    subEsperSessionizer.process(subSession,session,event);\n  }\n  if (subSession.getEventCount() == 1 && profile.getBeginMarker() != null) {\n    JetstreamEvent sessionBeginEvent=new JetstreamEvent();\n    sessionBeginEvent.setEventType(profile.getBeginMarker());\n    Map<String,Object> initialAttributes=subSession.getInitialAttributes();\n    if (initialAttributes != null) {\n      sessionBeginEvent.putAll(initialAttributes);\n    }\n    if (profile.getSessionIdKey() != null) {\n      sessionBeginEvent.put(profile.getSessionIdKey(),subSession.getSessionId());\n    }\n    if (mainSessionProfile.getSessionStartTimestampKey() != null) {\n      sessionBeginEvent.put(mainSessionProfile.getSessionStartTimestampKey(),subSession.getCreationTime());\n    }\n    if (subEsperSessionizer != null && subEsperSessionizer.isEventSupported(sessionBeginEvent)) {\n      subEsperSessionizer.process(subSession,session,sessionBeginEvent);\n    }\n    eventSender.sendSubSessionBeginEvent(mainSessionProfile.getSessionType(),subSession,sessionBeginEvent);\n  }\n}\n",
    "File_Path": "realtime-analytics/sessionizer/src/main/java/com/ebay/pulsar/sessionizer/impl/Sessionizer.java",
    "Start": 7838,
    "Stop": 12484,
    "Project_Name": "data/projects/realtime-analytics",
    "Method_Name": "processSubSession"
}