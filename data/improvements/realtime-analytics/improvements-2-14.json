{
    "Method_Improvements": {
        "Improvements": [
            {
                "Improvement": "Move the creation of SessionizerConfigValidator to the beginning of the method",
                "Change_Diff": "- SessionizerConfigValidator validator=new SessionizerConfigValidator(config,newBean);\n- List<String> errors=validator.validate();\n- if (!errors.isEmpty()) {\n-  throw new IllegalArgumentException('Config error: ' + errors);\n- }",
                "Description": "To avoid unnecessary execution of code, the creation of the SessionizerConfigValidator and the validation of the newBean should happen as early as possible. If the newBean is not valid, an exception is thrown and the rest of the method does not execute.",
                "Start": 6,
                "End": 10
            },
            {
                "Improvement": "Refactor the code to remove duplicate code",
                "Change_Diff": "- config.setReadQueryTimeout(newBean.getReadQueryTimeout());\n- config.setEnableReadOptimization(newBean.getEnableReadOptimization());\n- config.setMaxIdleTime(newBean.getMaxIdleTime());\n- config.setMainSessionProfiles(newBean.getMainSessionProfiles());\n- config.setEpl(newBean.getEpl());\n- config.setImports(newBean.getImports());\n- config.setRawEventDefinition(newBean.getRawEventDefinition());",
                "Description": "There is duplicate code for updating the config and rolling back in case of an error. This can be refactored by creating a method that takes in a config and a newBean and updates the config with the newBean values.",
                "Start": 22,
                "End": 40
            }
        ],
        "Final code": "@Override protected void processApplicationEvent(ApplicationEvent event){\n  if (event instanceof ContextBeanChangedEvent) {\n    ContextBeanChangedEvent bcInfo=(ContextBeanChangedEvent)event;\n    SessionizerConfig newBean=(SessionizerConfig)(bcInfo.getApplicationContext().getBean(config.getBeanName()));\n    if (newBean != lastConfig) {\n      SessionizerConfigValidator validator=new SessionizerConfigValidator(config,newBean);\n      List<String> errors=validator.validate();\n      if (!errors.isEmpty()) {\n        throw new IllegalArgumentException('Config error: ' + errors);\n      }\n      lastConfig=newBean;\n      updateConfigFromBean(config, newBean);\n      boolean isSuccess=false;\n      try {\n        for (SessionizerRunnable task : tasks) {\n          task.newCompiledConfig=new CompiledConfig(config,task);\n        }\n        isSuccess=true;\n      } finally {\n        if (!isSuccess) {\n          rollbackConfig(config, newBean);\n        }\n      }\n      refreshConfig();\n    }\n  }\n}\n\nprivate void updateConfigFromBean(SessionizerConfig config, SessionizerConfig newBean) {\n  config.setReadQueryTimeout(newBean.getReadQueryTimeout());\n  config.setEnableReadOptimization(newBean.getEnableReadOptimization());\n  config.setMaxIdleTime(newBean.getMaxIdleTime());\n  config.setMainSessionProfiles(newBean.getMainSessionProfiles());\n  config.setEpl(newBean.getEpl());\n  config.setImports(newBean.getImports());\n  config.setRawEventDefinition(newBean.getRawEventDefinition());\n}\n\nprivate void rollbackConfig(SessionizerConfig config, SessionizerConfig newBean) {\n  config.setReadQueryTimeout(newBean.getReadQueryTimeout());\n  config.setEnableReadOptimization(newBean.getEnableReadOptimization());\n  config.setMaxIdleTime(newBean.getMaxIdleTime());\n  config.setMainSessionProfiles(newBean.getMainSessionProfiles());\n  config.setEpl(newBean.getEpl());\n  config.setImports(newBean.getImports());\n  config.setRawEventDefinition(newBean.getRawEventDefinition());\n}"
    },
    "Old_Method": "@Override protected void processApplicationEvent(ApplicationEvent event){\n  if (event instanceof ContextBeanChangedEvent) {\n    ContextBeanChangedEvent bcInfo=(ContextBeanChangedEvent)event;\n    SessionizerConfig newBean=(SessionizerConfig)(bcInfo.getApplicationContext().getBean(config.getBeanName()));\n    if (newBean != lastConfig) {\n      lastConfig=newBean;\n      SessionizerConfigValidator validator=new SessionizerConfigValidator(config,newBean);\n      List<String> errors=validator.validate();\n      if (!errors.isEmpty()) {\n        throw new IllegalArgumentException(\"Config error: \" + errors);\n      }\n      int readQueryTimeout=config.getReadQueryTimeout();\n      boolean enableReadOptimization=config.getEnableReadOptimization();\n      int maxIdleTime=config.getMaxIdleTime();\n      List<SessionProfile> mainSessionProfiles=config.getMainSessionProfiles();\n      EPL epl=config.getEpl();\n      List<String> imports=config.getImports();\n      EsperDeclaredEvents rawEventDefinition=config.getRawEventDefinition();\n      config.setReadQueryTimeout(newBean.getReadQueryTimeout());\n      config.setEnableReadOptimization(newBean.getEnableReadOptimization());\n      config.setMaxIdleTime(newBean.getMaxIdleTime());\n      config.setMainSessionProfiles(newBean.getMainSessionProfiles());\n      config.setEpl(newBean.getEpl());\n      config.setImports(newBean.getImports());\n      config.setRawEventDefinition(newBean.getRawEventDefinition());\n      boolean isSuccess=false;\n      try {\n        for (        SessionizerRunnable task : tasks) {\n          task.newCompiledConfig=new CompiledConfig(config,task);\n        }\n        isSuccess=true;\n      }\n  finally {\n        if (!isSuccess) {\n          for (          SessionizerRunnable task : tasks) {\n            if (task.newCompiledConfig != null) {\n              task.newCompiledConfig.destroy();\n              task.newCompiledConfig=null;\n            }\n          }\n          config.setReadQueryTimeout(readQueryTimeout);\n          config.setEnableReadOptimization(enableReadOptimization);\n          config.setMaxIdleTime(maxIdleTime);\n          config.setMainSessionProfiles(mainSessionProfiles);\n          config.setEpl(epl);\n          config.setImports(imports);\n          config.setRawEventDefinition(rawEventDefinition);\n        }\n      }\n      refreshConfig();\n    }\n  }\n}\n",
    "File_Path": "realtime-analytics/sessionizer/src/main/java/com/ebay/pulsar/sessionizer/impl/SessionizerProcessor.java",
    "Start": 70925,
    "Stop": 73856,
    "Project_Name": "data/projects/realtime-analytics",
    "Method_Name": "processApplicationEvent"
}