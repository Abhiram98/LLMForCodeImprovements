{
    "Method_Improvements": {
        "Improvements": [
            {
                "Improvement": "Use method to avoid duplicate code",
                "Change_Diff": "- subSession.setIdentifier(subSessionIdenfifier);\n- ...\n- session.addSubSession(subSession);\n+ initializeSubSession(subSession, subSessionIdenfifier, profile, info, currentTime, eventTimestamp);",
                "Description": "There is a lot of duplicate code in this method that can be refactored into a separate method. Specifically, the code that sets the properties of the 'subSession' object appears twice and can be extracted into a separate method.",
                "Start": 6,
                "End": 31
            },
            {
                "Improvement": "Refactor long method",
                "Change_Diff": "- private void processSubSession(...){\n+ private void processSubSession(...){\n+ checkAndInitializeSubSession(...);\n+ processEventCount(...);\n+ updateSessionExpirationTime(...);\n+ processSubEsperSessionizer(...);\n+ processSessionBeginEvent(...);\n+ }",
                "Description": "This method is very long and can be difficult to understand. Consider breaking it down into smaller, more manageable methods.",
                "Start": 1,
                "End": 79
            }
        ],
        "Final code": "private void processSubSession(JetstreamEvent event,Session session,String mainIdentifier,SessionizationInfo info,SubSessionProfile profile,long eventTimestamp){\n  String subSessionIdenfifier=info.getIdentifier();\n  SubSession subSession=session.getSubSession(subSessionIdenfifier,profile.getName());\n  long currentTime=session.getLastModifiedTime();\n\n  checkAndInitializeSubSession(subSession, subSessionIdenfifier, profile, info, currentTime, eventTimestamp, session);\n\n  processEventCount(subSession, currentTime);\n\n  updateSessionExpirationTime(session, subSession);\n\n  EsperSessionizer subEsperSessionizer=subEsperSessionizerMap.get(profile.getName());\n\n  processSubEsperSessionizer(subEsperSessionizer, subSession, session, event);\n\n  processSessionBeginEvent(subSession, profile, mainIdentifier, session, subEsperSessionizer);\n}\n\nprivate void checkAndInitializeSubSession(SubSession subSession, String subSessionIdenfifier, SubSessionProfile profile, SessionizationInfo info, long currentTime, long eventTimestamp, Session session) {...}\n\nprivate void processEventCount(SubSession subSession, long currentTime) {...}\n\nprivate void updateSessionExpirationTime(Session session, SubSession subSession) {...}\n\nprivate void processSubEsperSessionizer(EsperSessionizer subEsperSessionizer, SubSession subSession, Session session, JetstreamEvent event) {...}\n\nprivate void processSessionBeginEvent(SubSession subSession, SubSessionProfile profile, String mainIdentifier, Session session, EsperSessionizer subEsperSessionizer) {...}"
    },
    "Old_Method": "private void processSubSession(JetstreamEvent event,Session session,String mainIdentifier,SessionizationInfo info,SubSessionProfile profile,long eventTimestamp){\n  String subSessionIdenfifier=info.getIdentifier();\n  SubSession subSession=session.getSubSession(subSessionIdenfifier,profile.getName());\n  long currentTime=session.getLastModifiedTime();\n  if (subSession == null) {\n    subSession=new SubSession();\n    subSession.setIdentifier(subSessionIdenfifier);\n    subSession.setName(profile.getName());\n    subSession.setCreationTime(currentTime);\n    subSession.setEventCount(1);\n    if (info.getTtl() > 0) {\n      subSession.setTtl(Math.min(info.getTtl(),maxSessionIdleTime));\n    }\n else {\n      subSession.setTtl(Math.min(profile.getDefaultTtl(),maxSessionIdleTime));\n    }\n    if (subSession.getTtl() > session.getTtl()) {\n      subSession.setTtl(session.getTtl());\n    }\n    subSession.setFirstEventTimestamp(eventTimestamp);\n    subSession.setLastModifiedTime(currentTime);\n    subSession.setExpirationTime(currentTime + subSession.getTtl());\n    subSession.setSessionId(concatTimestamp(session.getIdentifier(),subSessionIdenfifier,subSession.getFirstEventTimestamp()));\n    session.addSubSession(subSession);\n  }\n else   if (subSession.getExpirationTime() < session.getLastModifiedTime()) {\n    subSessionEnd(mainIdentifier,session,subSession);\n    subSession.setCreationTime(currentTime);\n    subSession.setEventCount(1);\n    if (info.getTtl() > 0) {\n      subSession.setTtl(Math.min(info.getTtl(),maxSessionIdleTime));\n    }\n else {\n      subSession.setTtl(Math.min(profile.getDefaultTtl(),maxSessionIdleTime));\n    }\n    if (subSession.getTtl() > session.getTtl()) {\n      subSession.setTtl(session.getTtl());\n    }\n    subSession.setFirstEventTimestamp(eventTimestamp);\n    subSession.setLastModifiedTime(currentTime);\n    subSession.setExpirationTime(currentTime + subSession.getTtl());\n    subSession.setSessionId(concatTimestamp(session.getIdentifier(),subSessionIdenfifier,subSession.getFirstEventTimestamp()));\n    if (subSession.getInitialAttributes() != null) {\n      subSession.getInitialAttributes().clear();\n    }\n    if (subSession.getDynamicAttributes() != null) {\n      subSession.getDynamicAttributes().clear();\n    }\n  }\n else {\n    subSession.setSessionId(concatTimestamp(session.getIdentifier(),subSessionIdenfifier,subSession.getFirstEventTimestamp()));\n    if (subSession.getEventCount() < Integer.MAX_VALUE) {\n      subSession.setEventCount(subSession.getEventCount() + 1);\n    }\n    subSession.setExpirationTime(currentTime + subSession.getTtl());\n    subSession.setLastModifiedTime(currentTime);\n  }\n  if (session.getExpirationTime() < subSession.getExpirationTime()) {\n    session.setExpirationTime(subSession.getExpirationTime());\n  }\n  EsperSessionizer subEsperSessionizer=subEsperSessionizerMap.get(profile.getName());\n  if (subEsperSessionizer != null && subEsperSessionizer.isEventSupported(event)) {\n    subEsperSessionizer.process(subSession,session,event);\n  }\n  if (subSession.getEventCount() == 1 && profile.getBeginMarker() != null) {\n    JetstreamEvent sessionBeginEvent=new JetstreamEvent();\n    sessionBeginEvent.setEventType(profile.getBeginMarker());\n    Map<String,Object> initialAttributes=subSession.getInitialAttributes();\n    if (initialAttributes != null) {\n      sessionBeginEvent.putAll(initialAttributes);\n    }\n    if (profile.getSessionIdKey() != null) {\n      sessionBeginEvent.put(profile.getSessionIdKey(),subSession.getSessionId());\n    }\n    if (mainSessionProfile.getSessionStartTimestampKey() != null) {\n      sessionBeginEvent.put(mainSessionProfile.getSessionStartTimestampKey(),subSession.getCreationTime());\n    }\n    if (subEsperSessionizer != null && subEsperSessionizer.isEventSupported(sessionBeginEvent)) {\n      subEsperSessionizer.process(subSession,session,sessionBeginEvent);\n    }\n    eventSender.sendSubSessionBeginEvent(mainSessionProfile.getSessionType(),subSession,sessionBeginEvent);\n  }\n}\n",
    "File_Path": "realtime-analytics/sessionizer/src/main/java/com/ebay/pulsar/sessionizer/impl/Sessionizer.java",
    "Start": 7838,
    "Stop": 12484,
    "Project_Name": "data/projects/realtime-analytics",
    "Method_Name": "processSubSession"
}