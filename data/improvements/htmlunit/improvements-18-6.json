{
    "Method_Improvements": {
        "Improvements": [
            {
                "Improvement": "Use try-with-resources for PoolingHttpClientConnectionManager",
                "Change_Diff": "- final PoolingHttpClientConnectionManager poolingmgr=new PoolingHttpClientConnectionManager(...)\n+ try (final PoolingHttpClientConnectionManager poolingmgr=new PoolingHttpClientConnectionManager(...)) {",
                "Description": "PoolingHttpClientConnectionManager should be used in a try-with-resources statement to ensure that the connection manager is properly closed when it is no longer needed.",
                "Start": 12,
                "End": 57
            },
            {
                "Improvement": "Throw specific exception instead of RuntimeException",
                "Change_Diff": "- throw new RuntimeException(e);\n+ throw new IllegalStateException(\"Failed to create connection manager\", e);",
                "Description": "Instead of throwing a generic RuntimeException, consider throwing a more specific exception, such as an IllegalStateException. This provides more information about the error and can help with debugging.",
                "Start": 58,
                "End": 60
            }
        ],
        "Final code": "\"/**\n * Has the exact logic in  {@link HttpClientBuilder#build()} which sets the {@code connManager} part,but with the ability to configure  {@code socketFactory}.\n */\nprivate static PoolingHttpClientConnectionManager createConnectionManager(final HttpClientBuilder builder){\n  try {\n    PublicSuffixMatcher publicSuffixMatcher=getField(builder,\"publicSuffixMatcher\");\n    if (publicSuffixMatcher == null) {\n      publicSuffixMatcher=PublicSuffixMatcherLoader.getDefault();\n    }\n    LayeredConnectionSocketFactory sslSocketFactory=getField(builder,\"sslSocketFactory\");\n    final SocketConfig defaultSocketConfig=getField(builder,\"defaultSocketConfig\");\n    final ConnectionConfig defaultConnectionConfig=getField(builder,\"defaultConnectionConfig\");\n    final boolean systemProperties=getField(builder,\"systemProperties\");\n    final int maxConnTotal=getField(builder,\"maxConnTotal\");\n    final int maxConnPerRoute=getField(builder,\"maxConnPerRoute\");\n    HostnameVerifier hostnameVerifier=getField(builder,\"hostnameVerifier\");\n    final SSLContext sslcontext=getField(builder,\"sslContext\");\n    final DnsResolver dnsResolver=getField(builder,\"dnsResolver\");\n    final long connTimeToLive=getField(builder,\"connTimeToLive\");\n    final TimeUnit connTimeToLiveTimeUnit=getField(builder,\"connTimeToLiveTimeUnit\");\n    if (sslSocketFactory == null) {\n      final String[] supportedProtocols=systemProperties ? split(System.getProperty(\"https.protocols\")) : null;\n      final String[] supportedCipherSuites=systemProperties ? split(System.getProperty(\"https.cipherSuites\")) : null;\n      if (hostnameVerifier == null) {\n        hostnameVerifier=new DefaultHostnameVerifier(publicSuffixMatcher);\n      }\n      if (sslcontext == null) {\n        if (systemProperties) {\n          sslSocketFactory=new SSLConnectionSocketFactory((SSLSocketFactory)SSLSocketFactory.getDefault(),supportedProtocols,supportedCipherSuites,hostnameVerifier);\n        }\n else {\n          sslSocketFactory=new SSLConnectionSocketFactory(SSLContexts.createDefault(),hostnameVerifier);\n        }\n      }\n else {\n        sslSocketFactory=new SSLConnectionSocketFactory(sslcontext,supportedProtocols,supportedCipherSuites,hostnameVerifier);\n      }\n    }\n    try (final PoolingHttpClientConnectionManager poolingmgr=new PoolingHttpClientConnectionManager(RegistryBuilder.<ConnectionSocketFactory>create().register(\"http\",new SocksConnectionSocketFactory()).register(\"https\",sslSocketFactory).build(),null,null,dnsResolver,connTimeToLive,connTimeToLiveTimeUnit != null ? connTimeToLiveTimeUnit : TimeUnit.MILLISECONDS)) {\n    if (defaultSocketConfig != null) {\n      poolingmgr.setDefaultSocketConfig(defaultSocketConfig);\n    }\n    if (defaultConnectionConfig != null) {\n      poolingmgr.setDefaultConnectionConfig(defaultConnectionConfig);\n    }\n    if (systemProperties) {\n      String s=System.getProperty(\"http.keepAlive\",\"true\");\n      if (\"true\".equalsIgnoreCase(s)) {\n        s=System.getProperty(\"http.maxConnections\",\"5\");\n        final int max=Integer.parseInt(s);\n        poolingmgr.setDefaultMaxPerRoute(max);\n        poolingmgr.setMaxTotal(2 * max);\n      }\n    }\n    if (maxConnTotal > 0) {\n      poolingmgr.setMaxTotal(maxConnTotal);\n    }\n    if (maxConnPerRoute > 0) {\n      poolingmgr.setDefaultMaxPerRoute(maxConnPerRoute);\n    }\n    return poolingmgr;\n  }\n  }\n catch (  final IllegalAccessException e) {\n    throw new IllegalStateException(\"Failed to create connection manager\", e);\n  }\n}\""
    },
    "Old_Method": "/** \n * Has the exact logic in  {@link HttpClientBuilder#build()} which sets the {@code connManager} part,but with the ability to configure  {@code socketFactory}.\n */\nprivate static PoolingHttpClientConnectionManager createConnectionManager(final HttpClientBuilder builder){\n  try {\n    PublicSuffixMatcher publicSuffixMatcher=getField(builder,\"publicSuffixMatcher\");\n    if (publicSuffixMatcher == null) {\n      publicSuffixMatcher=PublicSuffixMatcherLoader.getDefault();\n    }\n    LayeredConnectionSocketFactory sslSocketFactory=getField(builder,\"sslSocketFactory\");\n    final SocketConfig defaultSocketConfig=getField(builder,\"defaultSocketConfig\");\n    final ConnectionConfig defaultConnectionConfig=getField(builder,\"defaultConnectionConfig\");\n    final boolean systemProperties=getField(builder,\"systemProperties\");\n    final int maxConnTotal=getField(builder,\"maxConnTotal\");\n    final int maxConnPerRoute=getField(builder,\"maxConnPerRoute\");\n    HostnameVerifier hostnameVerifier=getField(builder,\"hostnameVerifier\");\n    final SSLContext sslcontext=getField(builder,\"sslContext\");\n    final DnsResolver dnsResolver=getField(builder,\"dnsResolver\");\n    final long connTimeToLive=getField(builder,\"connTimeToLive\");\n    final TimeUnit connTimeToLiveTimeUnit=getField(builder,\"connTimeToLiveTimeUnit\");\n    if (sslSocketFactory == null) {\n      final String[] supportedProtocols=systemProperties ? split(System.getProperty(\"https.protocols\")) : null;\n      final String[] supportedCipherSuites=systemProperties ? split(System.getProperty(\"https.cipherSuites\")) : null;\n      if (hostnameVerifier == null) {\n        hostnameVerifier=new DefaultHostnameVerifier(publicSuffixMatcher);\n      }\n      if (sslcontext == null) {\n        if (systemProperties) {\n          sslSocketFactory=new SSLConnectionSocketFactory((SSLSocketFactory)SSLSocketFactory.getDefault(),supportedProtocols,supportedCipherSuites,hostnameVerifier);\n        }\n else {\n          sslSocketFactory=new SSLConnectionSocketFactory(SSLContexts.createDefault(),hostnameVerifier);\n        }\n      }\n else {\n        sslSocketFactory=new SSLConnectionSocketFactory(sslcontext,supportedProtocols,supportedCipherSuites,hostnameVerifier);\n      }\n    }\n    final PoolingHttpClientConnectionManager poolingmgr=new PoolingHttpClientConnectionManager(RegistryBuilder.<ConnectionSocketFactory>create().register(\"http\",new SocksConnectionSocketFactory()).register(\"https\",sslSocketFactory).build(),null,null,dnsResolver,connTimeToLive,connTimeToLiveTimeUnit != null ? connTimeToLiveTimeUnit : TimeUnit.MILLISECONDS);\n    if (defaultSocketConfig != null) {\n      poolingmgr.setDefaultSocketConfig(defaultSocketConfig);\n    }\n    if (defaultConnectionConfig != null) {\n      poolingmgr.setDefaultConnectionConfig(defaultConnectionConfig);\n    }\n    if (systemProperties) {\n      String s=System.getProperty(\"http.keepAlive\",\"true\");\n      if (\"true\".equalsIgnoreCase(s)) {\n        s=System.getProperty(\"http.maxConnections\",\"5\");\n        final int max=Integer.parseInt(s);\n        poolingmgr.setDefaultMaxPerRoute(max);\n        poolingmgr.setMaxTotal(2 * max);\n      }\n    }\n    if (maxConnTotal > 0) {\n      poolingmgr.setMaxTotal(maxConnTotal);\n    }\n    if (maxConnPerRoute > 0) {\n      poolingmgr.setDefaultMaxPerRoute(maxConnPerRoute);\n    }\n    return poolingmgr;\n  }\n catch (  final IllegalAccessException e) {\n    throw new RuntimeException(e);\n  }\n}\n",
    "File_Path": "htmlunit/src/main/java/org/htmlunit/HttpWebConnection.java",
    "Start": 54222,
    "Stop": 58735,
    "Project_Name": "data/projects/htmlunit",
    "Method_Name": "createConnectionManager"
}